<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Play minecraft 1.8 in your browser" />
    <meta name="keywords" content="eaglercraft, eaglercraftx, minecraft, 1.8, 1.8.8" />
    <title>EaglercraftX 1.8</title>
    <meta property="og:locale" content="en-US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="EaglercraftX 1.8" />
    <meta property="og:description" content="Play minecraft 1.8 in your browser" />
    <meta property="og:image" content="favicon.png" />
    <link type="image/png" rel="shortcut icon" href="favicon.png" />
    <script type="text/javascript" src="classes.js"></script>
    <script type="text/javascript" src="fix-webm-duration.js"></script>
    <script type="text/javascript">
      "use strict";
      window.addEventListener("load", () => {
        if (document.location.href.startsWith("file:")) {
          alert("HTTP please, do not open this file locally, run a local HTTP server and load it via HTTP!");
        } else {
          
          // %%%%%%%%% launch options %%%%%%%%%%%%
          
          window.eaglercraftXOpts = {
            container: "game_frame",
            assetsURI: "assets.epk",
            localesURI: "lang/",
            servers: [
              /* example: { addr: "ws://localhost:8081/", name: "Local test server" } */
            ]
          };
          
          // %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
          
          var q = window.location.search;
          if (typeof q === "string" && q.startsWith("?")) {
            q = new URLSearchParams(q);
            var s = q.get("server");
            if (s) window.eaglercraftXOpts.joinServer = s;
          }
          
          main();
          
          //////////////////////
          // DEBUG INTERFACE  //
          //////////////////////
          
          // Utility: Append a new line (div) with the given message.
          function appendLine(el, message) {
            var line = document.createElement("div");
            line.textContent = message;
            el.appendChild(line);
            // Auto-scroll to bottom if needed.
            el.scrollTop = el.scrollHeight;
          }
          
          // Get our debug panels by their IDs.
          const relayInfoDiv = document.getElementById("relay-info");
          const advancedDebugDiv = document.getElementById("advanced-debug");
          
          // Relay Logging – add new messages for WebSocket connections.
          function addRelayLog(msg, evt) {
            let message = msg;
            if (evt && evt.message) {
              message += ": " + evt.message;
            }
            appendLine(relayInfoDiv, message);
          }
          
          // Advanced Debug Logging – add new lines for console output.
          function addAdvancedDebugLog(msg) {
            appendLine(advancedDebugDiv, msg);
          }
          
          // Monkey-patch the WebSocket constructor to intercept connections
          // for URLs starting with "wss://". Errors, open, and close events are logged.
          (function() {
            const OriginalWebSocket = window.WebSocket;
            window.WebSocket = function(url, protocols) {
              const ws = protocols ? new OriginalWebSocket(url, protocols) : new OriginalWebSocket(url);
              if (typeof url === "string" && url.startsWith("wss://")) {
                addRelayLog("Attempting relay connection: " + url);
                ws.addEventListener("open", function() {
                  addRelayLog("Connected: " + url);
                });
                ws.addEventListener("error", function(evt) {
                  addRelayLog("Error on connection: " + url, evt);
                });
                ws.addEventListener("close", function() {
                  addRelayLog("Closed connection: " + url);
                });
              }
              return ws;
            };
            window.WebSocket.prototype = OriginalWebSocket.prototype;
          })();
          
          // Advanced Debug – capture console output by overriding methods.
          const advancedDebugLogs = [];
          (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
              const message = "[LOG] " + args.join(" ");
              advancedDebugLogs.push(message);
              if (advancedDebugDiv.style.display !== "none") {
                addAdvancedDebugLog(message);
              }
              originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
              const message = "[ERROR] " + args.join(" ");
              advancedDebugLogs.push(message);
              if (advancedDebugDiv.style.display !== "none") {
                addAdvancedDebugLog(message);
              }
              originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
              const message = "[WARN] " + args.join(" ");
              advancedDebugLogs.push(message);
              if (advancedDebugDiv.style.display !== "none") {
                addAdvancedDebugLog(message);
              }
              originalWarn.apply(console, args);
            };
          })();
          
          // Toggle the display of the relay info panel.
          document.getElementById("btn-relay").addEventListener("click", function() {
            if (relayInfoDiv.style.display === "none" || relayInfoDiv.style.display === "") {
              relayInfoDiv.style.display = "block";
            } else {
              relayInfoDiv.style.display = "none";
            }
          });
          
          // Toggle the display of the advanced debug panel and its download button.
          document.getElementById("btn-adv-debug").addEventListener("click", function() {
            if (advancedDebugDiv.style.display === "none" || advancedDebugDiv.style.display === "") {
              advancedDebugDiv.style.display = "block";
              document.getElementById("btn-download").style.display = "block";
            } else {
              advancedDebugDiv.style.display = "none";
              document.getElementById("btn-download").style.display = "none";
            }
          });
          
          // Download button – creates a text file from the collected advanced debug logs.
          document.getElementById("btn-download").addEventListener("click", function() {
            const blob = new Blob([advancedDebugLogs.join("\n")], { type: 'text/plain' });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = "advanced_debug_logs.txt";
            downloadLink.click();
            URL.revokeObjectURL(downloadLink.href);
          });
          
        }
      });
    </script>
  </head>
  <body style="margin:0px;width:100vw;height:100vh;overflow:hidden;" id="game_frame">
    <!-- Debug UI Container – positioned at the top right -->
    <div id="debug-container" style="position: absolute; top: 10px; right: 10px; z-index: 10000;">
      <button id="btn-relay" style="display: block; margin-bottom: 5px;">Display Relay Info</button>
      <button id="btn-adv-debug" style="display: block; margin-bottom: 5px;">Advanced Debug</button>
      <button id="btn-download" style="display: none; margin-bottom: 5px;">Download Advanced Debug Logs</button>
      <div id="relay-info" style="display: none; background: white; color: black; padding: 10px; margin-bottom: 5px; max-height: 200px; overflow-y: auto;"></div>
      <div id="advanced-debug" style="display: none; background: white; color: black; padding: 10px; max-height: 200px; overflow-y: auto;"></div>
    </div>
  </body>
</html>
