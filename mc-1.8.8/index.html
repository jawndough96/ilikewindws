<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Play minecraft 1.8 in your browser" />
    <meta name="keywords" content="eaglercraft, eaglercraftx, minecraft, 1.8, 1.8.8" />
    <title>EaglercraftX 1.8</title>
    <meta property="og:locale" content="en-US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="EaglercraftX 1.8" />
    <meta property="og:description" content="Play minecraft 1.8 in your browser" />
    <meta property="og:image" content="favicon.png" />
    <link type="image/png" rel="shortcut icon" href="favicon.png" />
    <script type="text/javascript" src="classes.js"></script>
    <script type="text/javascript" src="fix-webm-duration.js"></script>

    <style>
      /* Debug info button styling */
      #debug-toggle {
          position: fixed;
          top: 10px;
          right: 10px;
          background-color: #ffffff;
          color: #000000;
          border: 1px solid #000000;
          padding: 5px 10px;
          font-family: Arial, sans-serif;
          cursor: pointer;
          z-index: 1000;
      }
      /* Debug panel styling */
      #debugPanel {
          position: fixed;
          top: 50px;
          right: 10px;
          width: 400px;
          max-height: 50vh;
          overflow-y: auto;
          background: #ffffff;
          color: #000000;
          border: 1px solid #000000;
          font-family: monospace;
          font-size: 12px;
          padding: 10px;
          z-index: 1000;
          display: none;
      }
      /* Download button styling (inside debug panel) */
      #downloadBtn {
          margin-bottom: 10px;
      }
    </style>

    <script type="text/javascript">
      "use strict";

      // Immediately override the console functions.
      (function() {
          // Backup the original console methods.
          var originalLog = console.log;
          var originalWarn = console.warn;
          var originalError = console.error;
          // Global array to store debug log messages.
          window.debugLogs = [];
          
          /**
           * Append message to log array and refresh the debug panel text.
           * Each message includes a timestamp, its type, and the content.
           */
          function addToDebugLog(type, args) {
              var timestamp = new Date().toLocaleTimeString();
              var message = "[" + timestamp + "] " + type + ": " + Array.from(args).join(" ");
              window.debugLogs.push(message);
              
              // Attempt to update the debug panel if it exists.
              var debugContent = document.getElementById("debugContent");
              if (debugContent) {
                  debugContent.textContent = window.debugLogs.join("\n");
              }
          }

          console.log = function() {
              addToDebugLog("LOG", arguments);
              originalLog.apply(console, arguments);
          };

          console.warn = function() {
              addToDebugLog("WARN", arguments);
              originalWarn.apply(console, arguments);
          };

          console.error = function() {
              addToDebugLog("ERROR", arguments);
              originalError.apply(console, arguments);
          };
      })();

      window.addEventListener("load", () => {
          if (document.location.href.startsWith("file:")) {
              alert("HTTP please, do not open this file locally, run a local HTTP server and load it via HTTP!");
          } else {
              // %%%%%%%%% Launch options %%%%%%%%%%%%
              window.eaglercraftXOpts = {
                  container: "game_frame",
                  assetsURI: "assets.epk",
                  localesURI: "lang/",
                  servers: [
                      /* example: { addr: "ws://localhost:8081/", name: "Local test server" } */
                  ]
              };

              // Handle query string for joining a server.
              var q = window.location.search;
              if (typeof q === "string" && q.startsWith("?")) {
                  q = new URLSearchParams(q);
                  var s = q.get("server");
                  if (s) window.eaglercraftXOpts.joinServer = s;
              }

              // Set up the debug controls.
              setupDebugControls();

              // Log an initial message so the debug panel has some visible text.
              console.log("Debug logging initialized.");

              // Start the main function (assumed to be defined in classes.js)
              main();
          }
      });

      /**
       * Creates and configures the "Debug info" button and the debug panel.
       * The debug panel shows log messages and includes a "Download Debug Logs" button.
       */
      function setupDebugControls() {
          // Create the "Debug info" button fixed at the top right.
          var debugBtn = document.createElement("button");
          debugBtn.id = "debug-toggle";
          debugBtn.textContent = "Debug info";
          document.body.appendChild(debugBtn);

          // Create the debug panel container.
          var debugPanel = document.createElement("div");
          debugPanel.id = "debugPanel";

          // Create the Download Debug Logs button.
          var downloadBtn = document.createElement("button");
          downloadBtn.id = "downloadBtn";
          downloadBtn.textContent = "Download Debug Logs";
          debugPanel.appendChild(downloadBtn);

          // Create a preformatted element to hold the log messages.
          var debugContent = document.createElement("pre");
          debugContent.id = "debugContent";
          debugContent.style.whiteSpace = "pre-wrap"; // Allow wrapping.
          debugPanel.appendChild(debugContent);

          document.body.appendChild(debugPanel);

          // Toggle the display of the debug panel when clicking the Debug info button.
          debugBtn.addEventListener("click", function() {
              if (debugPanel.style.display === "none" || debugPanel.style.display === "") {
                  debugPanel.style.display = "block";
                  // Refresh the content with all stored logs.
                  debugContent.textContent = window.debugLogs.join("\n");
              } else {
                  debugPanel.style.display = "none";
              }
          });

          // Download the debug logs as a text file when clicking the Download button.
          downloadBtn.addEventListener("click", function() {
              var content = window.debugLogs.join("\n");
              var blob = new Blob([content], { type: "text/plain" });
              var url = URL.createObjectURL(blob);

              var a = document.createElement("a");
              a.href = url;
              a.download = "debug_logs.txt";
              a.click();

              URL.revokeObjectURL(url);
          });
      }
    </script>
  </head>
  <body style="margin:0px;width:100vw;height:100vh;overflow:hidden;" id="game_frame">
    <!-- Game or app content is loaded via main() -->
  </body>
</html>
